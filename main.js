var chapters = [
    {
        name: "chapter_1",
        items: [
            ["强", "qi2ang", "强大 富强 坚强"],
            ["弱", "ru4o", "弱小 软弱，弱点"],
            ["赞", "z4an", "称赞，赞美，赞扬"],
            ["称", "ch1eng, ch4en", "称呼，名称，称体重"],
            ["导", "d3ao", "导游，引导，领导"],
            ["尊", "z1un", "尊敬，尊重"],
            ["敬", "j4ing", "尊敬，敬礼"],
            ["保", "b3ao", "保护，保佑，保险公司"],
            ["护", "h4u", "保护，护士，护理"],
            ["程", "ch2eng", "路程，工程师"],
            ["杨", "y2ang", "杨树，杨梅"],
            ["咛", "n2ing", "叮咛"],
            ["嗨", "h1ai", ""],
            ["注", "zh4u", "注意，注视，关注"],
            ["副", "f4u", "一副样子，一副手套，副校长"],
            ["中", "zh1ong, zh4ong", "中间，打中，百发百中"],
        ]
    },
    {
        name: "chapter_2",
        items: [
            ["颜", "y2an", "颜色，颜料，五颜六色"],
            ["交", "ji1ao", "交通，交叉，交流"],
            ["丰", "f2eng", "丰富，丰收"],
            ["首", "sh3ou", "首都，首先，首领"],
            ["农", "n2ong", "农民，农场，干农活"],
            ["民", "m2in", "农民，人民，居民"],
            ["充", "ch1ong", "充足，充分，充电"],
            ["研", "y2an", "研究，钻研，研磨"],
            ["究", "j1iu", "究竟，追究，终究"],
            ["枫", "f1eng", "枫树，红枫叶"],
            ["紫", "z3i", "紫色，紫葡萄"],
            ["愁", "ch2ou", "发愁，愁眉苦脸"],
            ["运", "y4un", "运输，运动，幸运"],
            ["科", "k1e", "科学"],
            ["柿", "sh4i", "柿子，西红柿"],
            ["乐", "l4e/yu4e", "快乐，音乐"],
        ]
    },
    {
        name: "chapter_3",
        items: [
            ["待", "d4ai", "等待，接待，对待"],
            ["招", "zh1ao", "招待，打招呼，招手"],
            ["报", "b4ao", "报纸，报道，报告"],
            ["躺", "t3ang", "躺下，躺椅，躺倒"],
            ["随", "su2i", "随时，随意，随心所欲"],
            ["调", "ti2ao/di4ao", "调节，调整，声调"],
            ["节", "ji2e", "节约，节日，母亲节"],
            ["宣", "xu1an", "宣传，宣布"],
            ["陆", "l4u", "陆地，飞机着陆"],
            ["虹", "h2ong", "彩虹"],
            ["尽", "j4in", "尽管，尽快，尽早"],
            ["客", "k4e", "客轮，客机，客人"],
            ["轮", "l2un", "轮船，轮换，轮流"],
            ["份", "f4en", "一份礼物"],
            ["板", "b3an", "木板，钢板"],
            ["递", "d4i", "传递，递给"],
            ["式", "sh4i", "样式，式样，公式"],
        ]
    },
    {
        name: "chapter_4",
        items: [
            ["隔", "g2e", "隔开，隔壁"],
            ["淡", "d4an", "淡水，清淡，咸淡"],
            ["谈", "t2an", "谈话，交谈，谈论"],
            ["宋", "s4ong", "宋朝，姓宋，南宋"],
            ["陈", "ch2en", "陈旧，陈年旧事"],
            ["号", "h4ao", "口号，记号，电话号码"],
            ["藤", "t2eng", "细藤，藤条"],
            ["缠", "ch2an", "缠绕，纠缠，缠住"],
            ["绕", "r4ao", "绕线，绕道行走"],
            ["浇", "ji1ao", "浇水，浇花，浇地，火上浇油"],
            ["偷", "tou", "小偷，偷偷的，偷东西"],
            ["斜", "xi2e", "歪斜，斜线，斜视"],
            ["旗", "q2i", "旗子，国旗，升旗"],
            ["虾", "xi1a", "烤龙虾，对虾，虾米"],
            ["滩", "t1an", "海滩，河滩，一滩血"],
            ["竟", "j4ing", "究竟，竟然，竟敢"],
        ]
    },
    {
        name: "chapter_5",
        items: [
            ["将", "ji1ang", "将军，将要，将来"],
            ["军", "j1un", "军人，军营，军装"],
            ["曹", "c2ao", "曹操，姓曹"],
            ["秤", "ch4eng", "电子秤，天平秤"],
            ["切", "qi1e/qi4e", "切开，切瓜，一切"],
            ["容", "r2ong", "容易，容器，无地自容，面容"],
            ["易", "y4i", "容易，简易，轻而易举"],
            ["弓", "g1ong", "弓箭，拉弓"],
            ["箭", "ji4an", "射箭，火箭"],
            ["射", "sh4e", "注射，射击，射门，反射"],
            ["斤", "j1in", "几百斤，五公斤"],
            ["庄", "zhu1ang", "庄稼，村庄，庄重"],
            ["稼", "ji4a", "庄稼"],
            ["操", "c1ao", "操场，操练，操作"],
            ["睬", "c3ai", "理睬，不理不睬"],
            ["岭", "l3ing", "山岭，分水岭"],
        ]
    },
    {
        name: "chapter_6",
        items: [
            ["尚", "sh4ang", "和尚，尚好"],
            ["庙", "mi4ao", "庙会，寺庙，观音庙"],
            ["瘦", "sh4ou", "瘦小，瘦弱，消瘦"],
            ["嚷", "r1ang", "嚷嚷"],
            ["瞎", "xi1a", "瞎子，瞎猜，瞎吹"],
            ["寓", "y4u", "寓言，公寓，寓所"],
            ["遇", "y4u", "遇到，相遇，遇见"],
            ["互", "h4u", "互相，相互，互助"],
            ["引", "y3in", "引路，引开，吸引"],
            ["失", "sh1i", "失败，失去，失望"],
            ["取", "q3u", "取消，领取，争取"],
            ["盲", "m2ang", "盲人，盲目"],
            ["趟", "t4ang", "走一趟"],
            ["柱", "zh4u", "柱子"],
            ["瘸", "qu2e", "瘸子，瘸腿，瘸着走"],
            ["哦", "4o/2o", ""],
        ]
    },
];

function buildPunctuation(s) {
    var punctuations = [
        ["1a", "ā"],
        ["2a", "á"],
        ["3a", "ǎ"],
        ["4a", "à"],
        ["1o", "ō"],
        ["2o", "ó"],
        ["3o", "ǒ"],
        ["4o", "ò"],
        ["1e", "ē"],
        ["2e", "é"],
        ["3e", "ě"],
        ["4e", "è"],
        ["1i", "ī"],
        ["2i", "í"],
        ["3i", "ǐ"],
        ["4i", "ì"],
        ["1u", "ū"],
        ["2u", "ú"],
        ["3u", "ǔ"],
        ["4u", "ù"],
        ["1v", "ǖ"],
        ["2v", "ǘ"],
        ["3v", "ǚ"],
        ["4v", "ǜ"],
        ["v", "ü"],
    ];

    for (const [key, value] of punctuations) {
        s = s.replace(key, value);
    }
    return s;
}


function buildDict() {
    var dict = [];

    for (const chapter of chapters) {
        for (const item of chapter.items) {
            dict.push({
                character: item[0],
                pinyin: buildPunctuation(item[1]),
                words: item[2],
                source: chapter.name,
                score: 0
            });
        }
    }

    return dict;
}

var dict = buildDict();

$(function() {
    var $card = $(".card");
    var cardTemplate = $("#card-template").html()

    function loadNext() {
        dict = dict.filter(item => item.score < 3);
        if (dict.length > 1) {
            var index = Math.floor(Math.random() * dict.length);
            var content = Mustache.render(cardTemplate, dict[index]);
            $card.html(content);
            $card.data("card-index", index);
        } else {
            $card.html("Done, nice job!");
            $card.data("card-index", -1);
        }
    }

    var ENTER_KEY = 13;
    var SPACE_KEY = 32;
    $(document).keypress(function(event) {
        index = $card.data("card-index");
        if (index < 0) {
            ;
        } else {
            var keycode = (event.keyCode ? event.keyCode : event.which);
            if (keycode == ENTER_KEY) {
                dict[index].score ++;
                loadNext();
            } else if (keycode == SPACE_KEY) {
                dict[index].score --;
                $card.find("#tips").removeClass("hidden");
            }
        }
    });

    loadNext();
});
